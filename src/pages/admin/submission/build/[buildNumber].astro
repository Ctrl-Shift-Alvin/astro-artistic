---
import Section from '@/components/astro-components/Section.astro';
import { AdminLogout } from '@/components/partials/admin/AdminLogout';
import Base from '@/templates/Base.astro';
import {
	cGetAuthToken,
	cGetUserLanguage,
	cSetUserLanguage
} from '@/shared/cookies';
import { defaultLanguageCode, getTranslation } from '@/backend/i18n';
import { jwtDecode, JwtPayload } from 'jwt-decode';
import { adminIsSetup } from '@/backend/admin';
import { AdminErrorsTable } from '@/components/partials/admin/AdminErrorsTable';
import { Button } from '@/components/components/Button';
import { AdminBuildOverview } from '@/components/partials/admin/AdminBuildOverview';

if (!adminIsSetup)
	return Astro.redirect('/');

const { buildNumber = '-1' } = Astro.params;

let buildNumberInt;
try {

	buildNumberInt = parseInt(buildNumber);
	if (!buildNumberInt)
		throw new Error();

} catch {

	Astro.response.status = 400;
	Astro.response.statusText = 'bad-request';

}

const translation = getTranslation(
	cGetUserLanguage(Astro) || defaultLanguageCode
);
if (!translation) {
	if (cGetUserLanguage(Astro) === null) {
		throw new Error('Could not load translations.');
	} else {
		cSetUserLanguage(null);
	}
}

const token = cGetAuthToken(Astro);
if (token) {
	const tokenExpiry = ((await jwtDecode(token)) as JwtPayload).exp;
	if (tokenExpiry) {
		if (Date.now() - tokenExpiry * 1000 > 0) {
			return Astro.redirect('/admin/login/');
		}
	}
} else {
	return Astro.redirect('/admin/login/');
}

const prevUrl = decodeURIComponent(Astro.url.searchParams.get('prevUrl') ?? '');

---
<Base
	head={{
		title: 'Submission ' + buildNumber,
		description: 'Seeing submission ' + buildNumber
	}}
	translation={translation}
>
	<Section center title={`Build ID '${buildNumber}' Overview`}>
		<AdminBuildOverview buildNumber={buildNumber} client:only="react" />
	</Section>
	<Section center title={`Errors`}>
		<AdminErrorsTable buildNumber={buildNumberInt} client:only="react" />
	</Section>
	<Section center className="pt-8">
			<Button
				actionPayload={{
					action: 'adminDeleteBuild',
					args: [buildNumber]
				}}
				client:only="react"
			>
				{'Remove'}
			</Button>

			<Button
				href={prevUrl ?? '/admin/home/'}
				client:only="react"
			>
				{'Back'}
			</Button>
		</Section>
	<Section center>
		<AdminLogout client:only="react" />
	</Section>
</Base>
